{"ast":null,"code":"export var socketMiddleware=function socketMiddleware(wsActions){return function(store){var socket=null;var isConnected=false;var reconnectTimer=0;var url='';return function(next){return function(action){var dispatch=store.dispatch;var wsConnect=wsActions.wsConnect,wsDisconnect=wsActions.wsDisconnect,wsSendMessage=wsActions.wsSendMessage,onOpen=wsActions.onOpen,onClose=wsActions.onClose,onError=wsActions.onError,onMessage=wsActions.onMessage,wsConnecting=wsActions.wsConnecting;if(wsConnect.match(action)){console.log('connect');url=action.payload;socket=new WebSocket(url);isConnected=true;dispatch(wsConnecting());}if(socket){socket.onopen=function(){dispatch(onOpen());};socket.onerror=function(err){console.log('error');};socket.onmessage=function(event){var data=event.data;var parsedData=JSON.parse(data);dispatch(onMessage(parsedData));};socket.onclose=function(event){if(event.code!==1000){console.log('error');dispatch(onError(event.code.toString()));}console.log('close');dispatch(onClose());if(isConnected){dispatch(wsConnecting());reconnectTimer=window.setTimeout(function(){dispatch(wsConnect(url));},3000);}};if(wsSendMessage&&wsSendMessage.match(action)){console.log('send');socket.send(JSON.stringify(action.payload));}if(wsDisconnect.match(action)){console.log('disconnect');clearTimeout(reconnectTimer);isConnected=false;reconnectTimer=0;socket.close();dispatch(onClose());}}next(action);};};};};","map":{"version":3,"names":["socketMiddleware","wsActions","store","socket","isConnected","reconnectTimer","url","next","action","dispatch","wsConnect","wsDisconnect","wsSendMessage","onOpen","onClose","onError","onMessage","wsConnecting","match","console","log","payload","WebSocket","onopen","onerror","err","onmessage","event","data","parsedData","JSON","parse","onclose","code","toString","window","setTimeout","send","stringify","clearTimeout","close"],"sources":["C:/Users/Nailusha/Desktop/yandex-dev/react-stellar-burger/src/services/store/middleware/socket-middleware.ts"],"sourcesContent":["import { ActionCreatorWithoutPayload, ActionCreatorWithPayload } from '@reduxjs/toolkit';\r\nimport { Middleware } from 'redux';\r\nimport { RootState } from '../../../utils/types';\r\n\r\n\r\n\r\nexport type TwsActionTypes = {\r\n    wsConnect: ActionCreatorWithPayload<string>,\r\n    wsDisconnect: ActionCreatorWithoutPayload,\r\n    wsSendMessage?: ActionCreatorWithPayload<any>,\r\n    wsConnecting: ActionCreatorWithoutPayload,\r\n    onOpen: ActionCreatorWithoutPayload,\r\n    onClose: ActionCreatorWithoutPayload,\r\n    onError: ActionCreatorWithPayload<string>,\r\n    onMessage: ActionCreatorWithPayload<any>,\r\n}\r\n\r\nexport const socketMiddleware = (wsActions: TwsActionTypes): Middleware<{}, RootState> => {\r\n    return (store) => {\r\n      let socket: WebSocket | null = null;\r\n      let isConnected = false;\r\n      let reconnectTimer = 0;\r\n      let url = '';\r\n\r\n      return next => action => {\r\n        const { dispatch } = store;\r\n        const { wsConnect, wsDisconnect, wsSendMessage, onOpen, \r\n          onClose, onError, onMessage, wsConnecting } = wsActions;\r\n\r\n        if (wsConnect.match(action)) {\r\n          console.log('connect')\r\n          url = action.payload;\r\n          socket = new WebSocket(url);\r\n          isConnected = true;\r\n          dispatch(wsConnecting());\r\n        }\r\n\r\n        if (socket) {\r\n          socket.onopen = () => {\r\n            dispatch(onOpen());\r\n          };\r\n  \r\n          socket.onerror = err  => {\r\n            console.log('error')\r\n          };\r\n  \r\n          socket.onmessage = event => {\r\n            const { data } = event;\r\n            const parsedData = JSON.parse(data);\r\n            dispatch(onMessage(parsedData));\r\n          };\r\n  \r\n          socket.onclose = event => {\r\n            if (event.code !== 1000) {\r\n              console.log('error')\r\n              dispatch(onError(event.code.toString()));\r\n            }\r\n            console.log('close')\r\n            dispatch(onClose());\r\n\r\n            if (isConnected) {\r\n              dispatch(wsConnecting());\r\n              reconnectTimer = window.setTimeout(() => {\r\n                dispatch(wsConnect(url));\r\n              }, 3000)\r\n            }\r\n\r\n          };\r\n  \r\n          if (wsSendMessage && wsSendMessage.match(action)) {\r\n            console.log('send')\r\n            socket.send(JSON.stringify(action.payload));\r\n          }\r\n\r\n          if (wsDisconnect.match(action)) {\r\n            console.log('disconnect')\r\n            clearTimeout(reconnectTimer)\r\n            isConnected = false;\r\n            reconnectTimer = 0;\r\n            socket.close();\r\n            dispatch(onClose());\r\n          }\r\n        }\r\n  \r\n        next(action);\r\n      };\r\n    };\r\n  };\r\n  "],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}